<% if @manual.checklist_responses.count == 0 # prevent dupes %>
  <% @manual.checklist_responses.build ChecklistItem.all.map{|m| {:checklist_item_id => m.id }} %>
<% end %>

<% previous_group_id = nil %>

<%= f.fields_for :checklist_responses, @manual.checklist_responses.sort_by(&:checklist_item_id) do |b| %>

  <% if previous_group_id != b.object.checklist_item.checklist_group_id %>
    <div class="checklist-group-header">
      <%= b.object.checklist_item.checklist_group.name %>
      <%= b.object.checklist_item.checklist_group.description.html_safe %>
    </div>
  <% end %> 
  
  <% previous_group_id = b.object.checklist_item.checklist_group_id %>
  

  <div class="field checklist">
    
    <% if b.object.checklist_item %>
    
    <div class="field-label">
        
        <%= b.label :response, b.object.checklist_item.label %>
    
    </div>
    
    <div class="field-input">
      
        <%= b.hidden_field :checklist_item_id, :value => b.object.checklist_item.id %>
        
        <%= b.send(b.object.checklist_item.field_type, :response) %>

        <p class="help"><%= b.object.checklist_item.helper.html_safe %></p>

    </div>
    
    <% end %>
    
  </div>
    
<% end %>